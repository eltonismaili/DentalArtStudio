package com.clinic.dentalclinicbackend.service.impl;

import com.clinic.dentalclinicbackend.dto.ContactRequest;
import com.clinic.dentalclinicbackend.service.EmailService;
import jakarta.mail.MessagingException;
import jakarta.mail.internet.MimeMessage;
import lombok.RequiredArgsConstructor;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.mail.javamail.MimeMessageHelper;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class EmailServiceImpl implements EmailService {

    private final JavaMailSender mailSender;

    @Override
    public void sendContactEmail(ContactRequest contactRequest) {
        try {
            MimeMessage message = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(message, true);

            helper.setTo("dentalartstudio.ks@gmail.com");
            helper.setSubject("ðŸ’¬ New message from " + contactRequest.getName());
            helper.setFrom(contactRequest.getEmail());

            String html = """
        <div style="font-family: 'Poppins', Arial, sans-serif; background: linear-gradient(135deg, #e0f7fa, #ffffff); padding: 40px;">
          <div style="max-width: 650px; margin: auto; background-color: #ffffff; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); overflow: hidden;">
            
            <div style="background: linear-gradient(90deg, #6a11cb, #2575fc); color: #ffffff; padding: 30px; text-align: center;">
              <h1 style="margin: 0; font-size: 28px;">ðŸ“© New Contact Message</h1>
            </div>

            <div style="padding: 30px;">
              <p style="font-size: 17px; color: #222;"><strong>Name:</strong> %s</p>
              <p style="font-size: 17px; color: #222;"><strong>Email:</strong> %s</p>
              <p style="font-size: 17px; color: #222;"><strong>Phone:</strong> %s</p>
              
              <hr style="border: none; border-top: 2px solid #eee; margin: 25px 0;">
              
              <p style="font-size: 17px; color: #222; margin-bottom: 10px;"><strong>Message:</strong></p>
              <div style="background: #f0f4f8; padding: 20px; border-left: 6px solid #2575fc; border-radius: 10px; color: #555; font-size: 16px; line-height: 1.8; box-shadow: inset 0 0 5px rgba(0,0,0,0.05);">
                %s
              </div>
            </div>

            <div style="background-color: #fafafa; text-align: center; padding: 20px; font-size: 14px; color: #777; border-top: 1px solid #eee;">
              <p style="margin: 0;">ðŸ¦· Dental Clinic | Sent via Website Contact Form</p>
            </div>
          </div>
        </div>
        """.formatted(
                    contactRequest.getName(),
                    contactRequest.getEmail(),
                    contactRequest.getPhone() != null ? contactRequest.getPhone() : "Not provided",
                    contactRequest.getMessage()
            );


            helper.setText(html, true); // true = send HTML
            mailSender.send(message);

        } catch (MessagingException e) {
            System.err.println("Email send failed: " + e.getMessage());
            e.printStackTrace(); // do ta shohÃ«sh nÃ« logs tÃ« Render
            throw new RuntimeException("Failed to send email", e);
        }
    }
}
